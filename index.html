<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agregar y mostrar pendientes con acciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #f1f4fb;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(52,119,235,0.09);
      margin-top: 2.5em; padding: 2em 2em 1em 2em;
      width: 100%; max-width: 430px;
      display: flex; flex-direction: column; align-items: center;
    }
    h1 {
      color: #3477eb;
      font-weight: 600;
      margin-bottom: 1em;
      font-size: 1.6em;
    }
    h2 {
      color: #255db3; margin-top: 2.2em; font-size: 1.16em; text-align:center;
    }
    .icon-user {
      font-size: 2.8em;
      color: #3477eb;
      margin-bottom: .2em;
    }
    label {
      font-weight: 600; margin-top: 5px;
      display: flex; align-items: center;
      font-size: 1em;
    }
    input[type="text"] {
      width: 100%; max-width: 220px;
      padding: 0.6em 1em;
      margin: 0.3em 0 1.3em 0;
      border-radius: 9px;
      border: 1px solid #3477eb30;
      background: #eef3fe;
      font-size: 1em;
      outline: none;
      transition: border 0.2s;
    }
    input[type="text"]:focus { border: 1.5px solid #3477eb; background: #e5ecfa;}
    button {
      background: #3477eb;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 0.7em 2em;
      margin-top: 0;
      cursor: pointer;
      box-shadow: 0 2px 10px #3477eb33;
      font-size: 1.08em;
      transition: background 0.2s, transform 0.18s;
      display: flex; align-items: center; gap: 6px;
    }
    button:hover {
      background: #255db3;
      transform: scale(1.04);
    }
    #feedback { min-height: 2em; font-weight: 500; margin-top: 1em; text-align: center; font-size: 1.13em; transition: color 0.3s;}
    .success { color: #21ab61; }
    .error { color: #e04747; }
    .table-wrapper {
      background: #f8fbff;
      border-radius: 13px;
      box-shadow: 0 1.5px 8px #3477eb13;
      margin-top: 1.2em;
      padding: 1em 0.8em;
      width:100%;
      max-width: 410px;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #eef3fe;
      font-size: 1em;
    }
    th, td {
      border: 1px solid #3477eb48;
      padding: 0.54em 1em;
      text-align: left;
      min-width:80px;
    }
    th {
      background: #3477eb;
      color: #fff; font-weight: 550;
      letter-spacing: .5px;
      font-size: 1.02em;
    }
    tr:nth-child(even) td {
      background: #dde8fa;
    }
    .actions {
      display: flex; gap: 14px; justify-content: center;
    }
    .icon-action {
      cursor: pointer; padding: 5px; border-radius: 7px;
      border: none; font-size: 1.15em; background: transparent;
      transition: background .15s, color .15s, transform .15s;
      color: #3487b8; outline: none;
    }
    .icon-action:hover, .icon-action:focus {
      background: #e1f2ff;
      color: #257a57;
      transform: scale(1.19);
    }
    .icon-action.delete:hover, .icon-action.delete:focus {
      background: #ffe7ea;
      color: #d53a0b;
    }
    .icon-action:active { transform: scale(0.97);}
    .icon-action[disabled] { color: #bbb; pointer-events:none;}
    .icon-action .fa { pointer-events:none;}
    .tooltip {
      visibility: hidden; opacity: 0;
      background: #232323ea; color: #fff;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.92em;
      position: absolute; z-index: 90;
      left: 50%; transform: translateX(-50%);
      bottom: 120%; white-space: nowrap;
      transition: opacity .17s;
    }
    .icon-action:hover .tooltip,
    .icon-action:focus .tooltip {
      visibility: visible; opacity: 1;
    }
    @media (max-width: 600px) {
      .container,.table-wrapper { max-width: calc(100vw - 20px);}
      table { font-size: 0.97em;}
    }
  </style>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <span class="icon-user"><i class="fa-solid fa-user"></i></span>
    <h1>Agregar nombre y mostrar pendientes</h1>
    <form id="addRowForm" autocomplete="off">
      <label for="nombre"><i class="fa-regular fa-address-card" style="margin-right:5px;"></i>Nombre:</label>
      <input type="text" required id="nombre" name="nombre" maxlength="60" autocomplete="off" placeholder="Ingrese el nombre..." />
      <button type="submit"><i class="fa-solid fa-plus"></i> Agregar</button>
    </form>
    <div id="feedback"></div>
    <h2>Lista de pendientes <br>(Completado = FALSE)</h2>
    <div class="table-wrapper">
      <div id="spreadsheet"></div>
    </div>
    <div id="error" class="error"></div>
  </div>

  <script>
    // Tu endpoint real de SheetDB:
    const endpoint = "https://sheetdb.io/api/v1/q52hcwnsqokuu";

    document.getElementById("addRowForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const nombre = document.getElementById("nombre").value.trim();

      if(!nombre) {
        document.getElementById("feedback").textContent = "El campo nombre no puede estar vacío.";
        document.getElementById("feedback").className = "error";
        return;
      }

      const datos = {
        data: [
          { "Nombre": nombre, "Completado": "FALSE" }
        ]
      };

      const btn = document.querySelector("button");
      btn.disabled = true;
      btn.style.opacity = 0.6;

      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      })
      .then(res => {
        btn.disabled = false;
        btn.style.opacity = 1;
        if (!res.ok) throw new Error("No se pudo agregar el dato");
        return res.json();
      })
      .then(response => {
        document.getElementById("feedback").textContent = "¡Dato agregado correctamente!";
        document.getElementById("feedback").className = "success";
        document.getElementById("addRowForm").reset();
        setTimeout(() => { cargarDatos(); }, 700);
      })
      .catch(err => {
        btn.disabled = false;
        btn.style.opacity = 1;
        document.getElementById("feedback").textContent =
          "Error al agregar dato: " + err.message;
        document.getElementById("feedback").className = "error";
      });
    });

    function cargarDatos() {
      fetch(endpoint)
        .then(res => {
          if (!res.ok) throw new Error("No se pudo cargar la hoja");
          return res.json();
        })
        .then(data => {
          let filtered = data
            .filter(row => row["Completado"] && row["Completado"].toString().toUpperCase() === "FALSE")
            .reverse();

          let html = '';
          if (filtered.length > 0) {
            html += `<table>
              <tr>
                <th>Nombre</th>
                <th>Acciones</th>
              </tr>`;
            filtered.forEach((row, idx) => {
              // Calcula un id único basado en la posición; si tienes SheetDB con columna "id", úsala
              const rowIndex = data.indexOf(row) + 2;  // +2 asumiendo encabezado, ajusta según tu hoja
              html += `<tr>
                <td>${row["Nombre"] || "-"}</td>
                <td>
                  <div class="actions">
                    <button class="icon-action complete" title="Marcar como completado" onclick="marcarCompletado(${rowIndex})">
                      <span class="tooltip">Marcar como completado</span>
                      <i class="fa-solid fa-circle-check"></i>
                    </button>
                    <button class="icon-action delete" title="Eliminar registro" onclick="eliminarRegistro(${rowIndex})">
                      <span class="tooltip">Eliminar</span>
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>`;
            });
            html += "</table>";
          } else {
            html = "<em>No hay registros con Completado = FALSE.</em>";
          }
          document.getElementById("spreadsheet").innerHTML = html;
          document.getElementById("error").textContent = "";
        })
        .catch(err => {
          document.getElementById("error").textContent =
            "Error cargando datos: " + err.message;
        });
    }

    // Acción: marcar como completado
    window.marcarCompletado = function(rowIndex) {
      // Actualización vía SheetDB PATCH, por posición en la hoja
      fetch(`${endpoint}/row/${rowIndex}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ "Completado": "TRUE" })
      })
      .then(res => {
        if (!res.ok) throw new Error("No se pudo marcar como completado");
        return res.json();
      })
      .then(response => {
        cargarDatos();
      })
      .catch(err => {
        document.getElementById("error").textContent =
          "Error al actualizar: " + err.message;
      });
    };

    // Acción: eliminar registro
    window.eliminarRegistro = function(rowIndex) {
      if(!confirm("¿Seguro que deseas eliminar este registro?")) return;
      fetch(`${endpoint}/row/${rowIndex}`, {
        method: "DELETE",
      })
      .then(res => {
        if (!res.ok) throw new Error("No se pudo eliminar el registro");
        return res.json();
      })
      .then(response => {
        cargarDatos();
      })
      .catch(err => {
        document.getElementById("error").textContent =
          "Error al eliminar: " + err.message;
      });
    };

    cargarDatos();
  </script>
</body>
</html>